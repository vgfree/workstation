<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
<title>cjson 源码阅读笔记_开源风暴_酷勤网</title>
<meta name="keywords" content="cjson,源码,阅读,笔记,之前,看了,sphinx,源码" />
<meta name="description" content="之前看了sphinx的源码之后，心中大概有了json实现的原型，但是没想到c语言的json实现是如此的暴力简单。 前言 cjson 的代码只有 1000+ 行， 而且只是简单的几个函数的调用。 而且 cjson 还有很多不完善的地方， 推荐大家看完之后自己实现一个 封装好的功能完" />
<link href="/new/css/style.css" rel="stylesheet" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="酷勤网_程序员的那点事" href="http://rss.kuqin.com/" />
<script type="text/javascript" src="/new/js/head.js"></script>
</head>
<body>
<!-- ShortCut begin -->
<div class="shortcut">
	<div class="vmid">
		<!-- SiteDescription begin -->
			<p class="description">酷勤网 C 程序员的那点事！</p>
		<!-- SiteDescription end -->
	</div>
</div>
<!-- ShortCut end -->
<!-- Wrapper begin -->
<div class="wrapper vmid">
	<!-- Header begin -->
    <div class="header">
		<div class="toplb">
			<!-- Logo begin -->
			<div class="logo"><a href="/" title="酷勤网-程序员的那点事" >酷勤网</a></div>
			<!-- Logo end -->
			<!-- AD_LogoBanner begin -->
			<div class="ad_logobanner">
				<script src='/plus/ad_js.php?aid=21' language='javascript'></script>                
				<div class="clear"></div>
			</div>
			<!-- AD_LogoBanner end -->
			
			<!-- TopFunction begin -->
			<div class="toptxt">
				<div>
					<a rel="external nofollow" href="#" onclick="this.style.behavior='url(#default#homepage)';this.setHomePage('http://www.kuqin.com');">设为首页</a><br />
					<a rel="external nofollow" href="javascript:window.external.AddFavorite('http://www.kuqin.com','酷勤网')">加入收藏</a><br />
					<a href="http://rss.kuqin.com/" title="订阅本站" target="_blank">订阅本站</a>
				</div>
			</div>
			<!-- TopFunction end -->
		</div>
		<div class="clear"></div>
		<!-- Navigation begin -->
		<div id="menu_out" style="margin-bottom:10px;">
<div id="menu_in">

<div id="menu">
<ul id="nav">
<li><a href="/" onmouseover="javascript:qiehuan(0)" id="mynav0" class="nav_off" ><span>首页</span></a></li>
<li class="menu_line"></li>
<li><a href="/jingyan/" onmouseover="javascript:qiehuan(1)" id="mynav1" class="nav_on"><span>编程</span></a></li>
<li class="menu_line"></li>
<li><a href="/product/" onmouseover="javascript:qiehuan(2)" id="mynav2" class="nav_off"><span>产品</span></a></li>
<li class="menu_line"></li>
<li><a href="/career/" onmouseover="javascript:qiehuan(3)" id="mynav3" class="nav_off"><span>职业</span></a></li>
<li class="menu_line"></li>
<li><a href="/manage/" onmouseover="javascript:qiehuan(4)" id="mynav4" class="nav_off"><span>管理</span></a></li>
<li class="menu_line"></li>
<li><a href="/shuoit/" onmouseover="javascript:qiehuan(5)" id="mynav5" class="nav_off"><span>资讯</span></a></li>
<li class="menu_line"></li>
<li><a href="/kaoshi/" onmouseover="javascript:qiehuan(6)" id="mynav6" class="nav_off"><span>考试</span></a></li>
<li class="menu_line"></li>
<li><a href="/game/" onmouseover="javascript:qiehuan(7)" id="mynav7" class="nav_off"><span>游戏</span></a></li>
<li class="menu_line"></li>
<li><a href="/book/" onmouseover="javascript:qiehuan(8)" id="mynav8" class="nav_off"><span>读书</span></a></li>
<li class="menu_line"></li>
<li><a href="/topics/" onmouseover="javascript:qiehuan(9)" id="mynav9" class="nav_off"><span>主题</span></a></li>
<li class="menu_line"></li>
<li><a href="/down/" onmouseover="javascript:qiehuan(10)" id="mynav10" class="nav_off"><span>下载</span></a></li>
</ul>

<div id="menu_con">
<div id="qh_con0" style="display:none">
<ul>
  
  <li><a href="/topics/love.html" target="_blank"><span>程序员爱情</span></a></li>
  <li class="menu_line2"></li>
  
  <li><a href="/topics/tiobe.html" target="_blank"><span>编程语言排行榜</span></a></li>
  <li class="menu_line2"></li>
  
  <li><a href="/topics/programmer.html" target="_blank"><span>程序员</span></a></li>
  <li class="menu_line2"></li>
  
  <li><a href="/topics/12306.html" target="_blank"><span>12306火车票系统</span></a></li>
  <li class="menu_line2"></li>
  
  <li><a href="/topics/Facebook.html" target="_blank"><span>Facebook</span></a></li>
  <li class="menu_line2"></li>
  
  <li><a href="/topics/Dijkstra.html" target="_blank"><span>Dijkstra算法</span></a></li>
  <li class="menu_line2"></li>
  
</ul>
</div>
 
<div id="qh_con1" style="display:block">
<ul>
  	
	<li><a href="/gamedev/" target="_blank"><span>游戏开发</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/cio/" target="_blank"><span>企业信息化</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/system-analysis/" target="_blank"><span>系统架构</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/web/" target="_blank"><span>Web开发</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/java/" target="_blank"><span>Java技术</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/dotnet/" target="_blank"><span>.Net技术</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/linux/" target="_blank"><span>Linux社区</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/mobile/" target="_blank"><span>移动开发</span></a></li>
	<li class="menu_line2"></li>
	
</ul>
</div> 

<div id="qh_con2" style="display:none">
<ul>
	
	<li><a href="/uidesign/" target="_blank"><span>交互设计</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/artdesign/" target="_blank"><span>视觉设计</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/webpagedesign/" target="_blank"><span>网页设计</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/shuoit/web-marketing/" target="_blank"><span>网络营销</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/shuoit/advertisement/" target="_blank"><span>网络广告</span></a></li>
	<li class="menu_line2"></li>
	
</ul>
</div> 

<div id="qh_con3" style="display:none">
<ul>
	
	<li><a href="/law/" target="_blank"><span>IT法律</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/humor/" target="_blank"><span>IT幽默</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/itlife/" target="_blank"><span>程序人生</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/job/" target="_blank"><span>求职招聘</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/itman/" target="_blank"><span>IT人物</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/chuangye/" target="_blank"><span>IT人创业</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/zhanz/" target="_blank"><span>站长经验</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/editor/" target="_blank"><span>网络编辑</span></a></li>
	<li class="menu_line2"></li>
	
</ul>
</div> 
<div id="qh_con4" style="display:none">
<ul>
	
	<li><a href="/ruhe/" target="_blank"><span>如何学习</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/pragmatic/" target="_blank"><span>修炼之道</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/managetool/" target="_blank"><span>管理工具</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/developtool/" target="_blank"><span>开发工具</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/projectmanage/" target="_blank"><span>项目管理</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/software-engineer/" target="_blank"><span>软件工程</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/health/" target="_blank"><span>程序员健康</span></a></li>
	<li class="menu_line2"></li>
	
</ul>
</div>

<div id="qh_con5" style="display:none">
<ul>
	
	<li><a href="/shuoit/it/" target="_blank"><span>业界</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/shuoit/telecom/" target="_blank"><span>通信与电信</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/shuoit/digital/" target="_blank"><span>数码与手机</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/shuoit/data/" target="_blank"><span>数据中心</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/shuoit/elec/" target="_blank"><span>家电</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/shuoit/web/" target="_blank"><span>互联网</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/shuoit/service/" target="_blank"><span>网络服务</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/shuoit/it-history/" target="_blank"><span>IT史记</span></a></li>
	<li class="menu_line2"></li>
	
</ul>
</div>

<div id="qh_con6" style="display:none">
<ul>
	
	<li><a href="/baike/" target="_blank"><span>IT知识百科</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/itkaoyan/" target="_blank"><span>IT考研</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/contest/" target="_blank"><span>竞赛比赛</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/kaozheng/" target="_blank"><span>培训考证</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/tiku/" target="_blank"><span>题库中心</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/english/" target="_blank"><span>程序员英语</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/math/" target="_blank"><span>程序员数学</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/CET4-CET6/" target="_blank"><span>英语四六级</span></a></li>
	<li class="menu_line2"></li>
	
</ul>
</div>

<div id="qh_con7" style="display:none">
<ul>
	
	<li><a href="/game/news/" target="_blank"><span>游戏资讯</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/game/pc/" target="_blank"><span>单机游戏</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/game/tv/" target="_blank"><span>电视游戏</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/game/m/" target="_blank"><span>手机游戏</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/game/netgames/" target="_blank"><span>网络游戏</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/game/webgame/" target="_blank"><span>网页游戏</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/game/esports/" target="_blank"><span>电子竞技</span></a></li>
	<li class="menu_line2"></li>
	
</ul>
</div>

<div id="qh_con8" style="display:none">
<ul>
  <li><a href="/book/" target="_blank"><span>书籍百科</span></a></li>
  <li class="menu_line2"></li>
  <li><a href="/shuping/" target="_blank"><span>书籍书评</span></a></li>
  <li class="menu_line2"></li>
</ul>
</div>

<div id="qh_con9" style="display:none">
<ul>
  
  <li><a href="/topics/YuEbao.html" target="_blank"><span>余额宝</span></a></li>
  <li class="menu_line2"></li>
  
  <li><a href="/topics/ThurayaSatelliteSystem.html" target="_blank"><span>Thuraya卫星系统</span></a></li>
  <li class="menu_line2"></li>
  
  <li><a href="/topics/standbytime.html" target="_blank"><span>待机时间</span></a></li>
  <li class="menu_line2"></li>
  
  <li><a href="/topics/smartantenna.html" target="_blank"><span>智能天线</span></a></li>
  <li class="menu_line2"></li>
  
  <li><a href="/topics/NetworkProgramming.html" target="_blank"><span>网络编程</span></a></li>
  <li class="menu_line2"></li>
  
  <li><a href="/topics/Scientist.html" target="_blank"><span>科学家</span></a></li>
  <li class="menu_line2"></li>
  
</ul>
</div>

<div id="qh_con10" style="display:none">
<ul>
	
	<li><a href="/bookdown/" target="_blank"><span>电子书下载</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/softdown/" target="_blank"><span>软件下载</span></a></li>
	<li class="menu_line2"></li>
	
	<li><a href="/codedown/" target="_blank"><span>源码下载</span></a></li>
	<li class="menu_line2"></li>
	
</ul>
</div>
	<!-- Search begin -->
	<div style="float:right; margin-top:7px;">
	<form action="http://www.google.com/cse" id="cse-search-box" target="_blank">
	<input type="hidden" name="cx" value="003441317781501573535:of4gx8okfgw" />
	<input type="hidden" name="ie" value="gb2312" />
	<input name="q" class="search_k" type="text" />
	<input name="sa" type="submit" value="" class="search_s" />
	</form>
	</div>
	<!-- Search end -->

</div>
</div></div></div> 
		<!-- Navigation end -->
		<div class="clear"></div>
	</div>
	<!-- Header end -->
	<!-- Container begin -->
	<div class="container">
		<!-- Content begin -->
		<div class="content">
		
		<div class="ccca">
		
		  <div class="breadcrumb article_dq">
				当前位置：<a href='http://www.kuqin.com/'>首页</a> > <a href='/jingyan/'>编程</a> > <a href='/opensource/'>开源风暴</a> > 正文
			</div>
			<!-- SinglePost begin -->
			<div class="single">
				<h1><a href="http://www.kuqin.com/shuoit/20141224/344068.html" target="_blank"  >cjson 源码阅读笔记</a></h1>
				<div class="meta singlemeta">
					<span>浏览次数：<script src="/plus/count.php?view=yes&aid=344068&mid=2" type='text/javascript' language="javascript"></script>次</span>
					<span class="cmts"><a href='http://github.tiankonguse.com/blog/2014/12/18/cjson-source/' target='_blank' rel='external nofollow'>tiankonguse .github..io</a> 
					</span>
					<span>2014年12月24日</span>
					<span>字号: <a rel="external nofollow" class="mfbig" href="javascript:void(0)">大</a> <a rel="external nofollow"  class="mfmid" href="javascript:void(0)">中</a> <a rel="external nofollow" class="mfsml mfcurrent" href="javascript:void(0)">小</a> </span>
				</div>
				<!-- JiaThis Button BEGIN -->
				<script language="JavaScript" src="/new/js/jia1.js" type="text/JavaScript"></script>
				<!-- JiaThis Button END -->
				<div class="clear"></div>
				<!-- PostContent begin -->
				<div class="entry">
					<div class="entrycontent">
						<div style="float:right;margin-top:20px;margin-left:0px">
						<script type="text/javascript"><!--
						google_ad_client = "ca-pub-9317413389774415";
						/* 2012年文章页头部336&#42;280 */
						google_ad_slot = "9598016854";
						google_ad_width = 336;
						google_ad_height = 280;
						//-->
						</script>
						<script type="text/javascript"
						src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
						</script>
						</div>
						<blockquote style="box-sizing: border-box; padding: 10px 20px; margin: 0px 0px 20px 25px; border-left-width: 5px; border-left-style: solid; border-left-color: rgb(238, 238, 238); font-style: italic; color: rgb(51, 51, 51); font-family: 微软雅黑, Arial, Helvetica, sans-serif;">之前看了sphinx的源码之后，心中大概有了json实现的原型，但是没想到c语言的json实现是如此的暴力简单。</blockquote>
<h3>前言</h3>
<p>cjson 的代码只有 1000+ 行， 而且只是简单的几个函数的调用。</p>
<p>而且 cjson 还有很多不完善的地方， 推荐大家看完之后自己实现一个 封装好的功能完善的 cjson 程序。</p>
<h3>json 基本信息</h3>
<p>在阅读 json 之前， 建议阅读一下<a href="http://www.json.org/" target="_blank" class="external">json 的官方介绍</a>。</p>
<p>如果上面的英文吓到你了的话， 可以看看这个<a href="http://www.json.org/json-zh.html" target="_blank" class="external">中文翻译版本</a>.</p>
<p>我的 这个 cjson 是从官网指定的地方下载的<a href="http://sourceforge.net/projects/cjson/" target="_blank" class="external">ourceforge</a>.</p>
<p>在看完官网的介绍后，我们知道 json 的 value 存在这么几种类型: 对象， 数组， 字符串， 数字， true, false, null。</p>
<p>其中对象是一个 key-value 的集合， 而数组是一些 value 的有序列表。</p>
<p>于是 cjson 中在 头文件中定义了 这些类型的数字编号和 cJSON value 的结构体。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* cJSON Types: */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_False 0</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_True 1</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_NULL 2</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_Number 3</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_String 4</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_Array 5</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_Object 6</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_IsReference 256</code></li></ol></pre>
<p>对于上面的 define , 如果是我的话，会选择 emnu 来实现这个类型的定义。</p>
<p>例如</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">enum {cJSON_False, cJSON_True, cJSON_NULL, cJSON_Number, cJSON_String, cJSON_Array, cJSON_Object, cJSON_IsReference=256};</code></li></ol></pre>
<p>然后是 json 一个 value 的结构，看注释也都可以明白干什么的。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* The cJSON structure: */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">typedef struct cJSON {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    struct cJSON *next,*prev;   /同一级的元素使用双向列表储存/</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    struct cJSON *child;        /* 如果是个 object 或 array 的话，第一个儿子的指针 */</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    int type;                   /* value 的类型 */</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    char *valuestring;          /* 如果这个 value 是 字符串 的话，字符串值 */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    int valueint;               /* 如果是数字的话，整数值 */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    double valuedouble;         /* 如果是数字的话，浮点数值 */</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    char *string;               /* 如果是对象的 key-value 元素的话， key 值 */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">} cJSON;</code></li></ol></pre>
<h3>json 内存管理</h3>
<h4>hook 管理函数</h4>
<p>在 c 语言中内存一般是 malloc 和 free 的。</p>
<p>为了方便用户自由的管理内存， cjson 使用 Hook 技术来让使用者可以自定义内存管理函数。</p>
<p>即用户自定义 malloc 和 free.</p>
<p>具体实现方式可以参考下面的代码， 默认使用系统的 malloc 和 free 函数， 用过 cJSON_InitHooks 函数可以替换成用户自定义的 malloc 和 free 函数。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">typedef struct cJSON_Hooks {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    void *(*malloc_fn)(size_t sz);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    void (*free_fn)(void *ptr);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">} cJSON_Hooks;</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static void *(*cJSON_malloc)(size_t sz) = malloc;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static void (*cJSON_free)(void *ptr) = free;</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">void cJSON_InitHooks(cJSON_Hooks* hooks) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!hooks) { /* Reset hooks */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON_malloc = malloc;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON_free = free;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON_malloc = (hooks-&gt;malloc_fn)?hooks-&gt;malloc_fn:malloc;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON_free = (hooks-&gt;free_fn)?hooks-&gt;free_fn:free;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<h4>创建节点</h4>
<p>有了内存管理函数，我们就可以生成我们的 value 节点了。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Internal constructor. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static cJSON *cJSON_New_Item(void) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON* node = (cJSON*)cJSON_malloc(sizeof(cJSON));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (node) memset(node,0,sizeof(cJSON));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return node;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<p>然后通过再设置具体的类型即生成对应类型的节点。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Create basic types: */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateNull(void) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *item=cJSON_New_Item();</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if(item)item-&gt;type=cJSON_NULL;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return item;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateTrue(void);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateFalse(void);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateBool(int b) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *item=cJSON_New_Item();</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if(item)item-&gt;type=b?cJSON_True:cJSON_False;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return item;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateNumber(double num) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *item=cJSON_New_Item();</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if(item) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        item-&gt;type=cJSON_Number;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        item-&gt;valuedouble=num;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        item-&gt;valueint=(int)num;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return item;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateString(const char *string) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *item=cJSON_New_Item();</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if(item) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        item-&gt;type=cJSON_String;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        item-&gt;valuestring=cJSON_strdup(string);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return item;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateArray(void);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateObject(void);</code></li></ol></pre>
<p>上面我们看到一个 cJSON_strdup 函数， 简单的理解就是复制字符串，返回新的字符串的指针。</p>
<h4>删除节点</h4>
<p>删除节点很简单， 先删除儿子，然后清理内存即可。</p>
<p>总结一下就是对于 object 和 array 需要先删除儿子，然后删除自己。<br />
对于 字符串， 需要先释放字符串的内存， 再释放自己这块内存。<br />
对于其他节点，直接释放自己这块内存。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Delete a cJSON structure. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">void cJSON_Delete(cJSON *c) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (c) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        next=c-&gt;next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (!(c-&gt;type&amp;cJSON_IsReference) &amp;&amp; c-&gt;child) cJSON_Delete(c-&gt;child);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (!(c-&gt;type&amp;cJSON_IsReference) &amp;&amp; c-&gt;valuestring) cJSON_free(c-&gt;valuestring);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (c-&gt;string) cJSON_free(c-&gt;string);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON_free(c);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        c=next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<h3>节点操作</h3>
<p>有了内存管理，我们就可以得到一些列不同类型的节点了。</p>
<p>然后我们通过节点操作就可以把这些节点连接起来，组成一棵树。</p>
<p>是的，所有的json 都可以理解为一颗有根树。</p>
<p>而节点操作有把加点 a 添加为节点 b 的儿子， 把节点 b 从节点 a 的儿子中删除。</p>
<p>或者修改节点 a 的值或者查询节点 a 的值。</p>
<p>对，就是传说中的<strong>增删改查</strong>。</p>
<h4>添加儿子节点</h4>
<p>添加儿子节点有两种情况，一种是给 object 增加儿子， 一种是给 array 增加儿子。</p>
<p>object 和 array 相比, 仅仅多了一个操作 ，即设置 key .</p>
<p>所以我们可以再 object 中设置完 key 之后再调用 给 array 添加儿子的操作来实现给 object 添加儿子。</p>
<p>具体参考胆码。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Utility for array list handling. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static void suffix_object(cJSON *prev,cJSON *item) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    //两个兄弟的指针互相指向对方</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    prev-&gt;next=item; </code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;prev=prev;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Add item to array/object. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">void   cJSON_AddItemToArray(cJSON *array, cJSON *item) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *c=array-&gt;child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!item) return;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!c) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        array-&gt;child=item; //之前没有儿子，直接添加</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    } else {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        while (c &amp;&amp; c-&gt;next) c=c-&gt;next; // 先找到最后一个儿子。</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        suffix_object(c,item); // 添加儿子， c 是 item 的兄弟</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">void   cJSON_AddItemToObject(cJSON *object,const char *string,cJSON *item) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!item) return;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (item-&gt;string) cJSON_free(item-&gt;string);//这个 儿子之前有key, 先清理了。  </code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;string=cJSON_strdup(string); // 设置 key</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON_AddItemToArray(object,item); // 添加儿子</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<p>实际上上面这两个操作即可满足我们的添加需求了。</p>
<p>但是 cjson 为了我们更方便的使用添加节点的操作， 它又封装了一些操作， 当然使用宏定义封装的。</p>
<p>比如我们平常给 object 增加一个 false 儿子需要这样</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON_AddItemToObject(object, name, cJSON_CreateFalse())</code></li></ol></pre>
<p>现在我们只需要这样</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON_AddFalseToObject(object,name)</code></li></ol></pre>
<p>具体实现方式就是定义一个宏。</p>
<p>而且 cjson 只定义了对象的添加，而没有对数组定义这个宏。</p>
<p>大概原因是那时候， 一般一个数组内的元素的类型都是相同的吧， 不像对象这么灵活。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Macros for creating things quickly. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_AddNullToObject(object,name)      cJSON_AddItemToObject(object, name, cJSON_CreateNull())</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_AddTrueToObject(object,name)      cJSON_AddItemToObject(object, name, cJSON_CreateTrue())</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_AddFalseToObject(object,name)     cJSON_AddItemToObject(object, name, cJSON_CreateFalse())</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_AddBoolToObject(object,name,b)    cJSON_AddItemToObject(object, name, cJSON_CreateBool(b))</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_AddNumberToObject(object,name,n)  cJSON_AddItemToObject(object, name, cJSON_CreateNumber(n))</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">#define cJSON_AddStringToObject(object,name,s)  cJSON_AddItemToObject(object, name, cJSON_CreateString(s))</code></li></ol></pre>
<p>因此 cjson 还专门为 数组定义了下面的批量创建节点。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* These utilities create an Array of count items. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateIntArray(const int *numbers,int count);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateFloatArray(const float *numbers,int count);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateDoubleArray(const double *numbers,int count);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_CreateStringArray(const char **strings,int count);</code></li></ol></pre>
<p>另外， 当我们要添加的节点已经在一个树上的时候， 再向另一个树中添加这个节点时， 这个节点的 pre 和 next 指针会被覆盖。</p>
<p>于是 cjson 又提供了一种引用性添加节点的方法。</p>
<p>简单的说就是在创建一个 item, 新创建的 item 的 value 指针直接指向原来的 value 值， 这样两个 item 就指向了同一个 item 了。</p>
<p>但是这个引用计数是个难题， cjson 也没有处理好， 只能引用一次， 大家可以想象怎么解决。</p>
<p>我们先来看看 cjson 的引用是怎么实现的。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Utility for handling references. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static cJSON *create_reference(cJSON *item) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *ref=cJSON_New_Item();</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!ref) return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    memcpy(ref,item,sizeof(cJSON));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    ref-&gt;string=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    ref-&gt;type|=cJSON_IsReference;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    ref-&gt;next=ref-&gt;prev=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return ref;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<p>上面的引用计数仅仅存在 type 里面，显示是有问题的。</p>
<p>我们的 value 是保持不变的，所有的引用都指向这个value.</p>
<p>所以我们可以通过一个和 value 类似的东西， 大家都指向这个 东西， 新增加一个引用的时候加1， 释放一个引用的时候减一即可。</p>
<p>这个看着怎么那么像智能指针呢？</p>
<p>这个话题就说到这吧，实现方式很多的，大家自己多想想。</p>
<h4>删除儿子节点</h4>
<p>删除也是从 array 和 object 中删除，实现就比较简洁了。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">void   cJSON_DeleteItemFromArray(cJSON *array,int which) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON_Delete(cJSON_DetachItemFromArray(array,which));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">void   cJSON_DeleteItemFromObject(cJSON *object,const char *string) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON_Delete(cJSON_DetachItemFromObject(object,string));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<p>Detach 是什么东西呢？</p>
<p>我们把一个节点从 json 树中删除， 但是不释放内存，而是先保留这个节点的指针， 这样储存在这个节点的信息都保留了下来。</p>
<p>接下来我们就可以做很多事了， 合适的时候添加到其他对象中， 合适的时候释放内存。</p>
<p>比如上面的 delete 函数， 就需要真实的删除了， 这个时候我们删除即可。</p>
<p>而 detach 实现也比较简单， 只是少了一步删除操作。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">// 节点从双向链表中删除即可</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_DetachItemFromArray(cJSON *array,int which) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *c=array-&gt;child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (c &amp;&amp; which&gt;0) c=c-&gt;next,which--;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!c) return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (c-&gt;prev) c-&gt;prev-&gt;next=c-&gt;next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (c-&gt;next) c-&gt;next-&gt;prev=c-&gt;prev;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (c==array-&gt;child) array-&gt;child=c-&gt;next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    c-&gt;prev=c-&gt;next=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return c;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_DetachItemFromObject(cJSON *object,const char *string) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    int i=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *c=object-&gt;child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (c &amp;&amp; cJSON_strcasecmp(c-&gt;string,string)) i++,c=c-&gt;next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (c) return cJSON_DetachItemFromArray(object,i);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<h4>查找节点</h4>
<p>对于一般类型的item, 我们直接就得到对应的节点.</p>
<p>但是对于 array 和 object , 我们需要查找对应的节点, 所以就需要去查找了。</p>
<p>这个查找算法由 cjson 的储存节点方式决定着。</p>
<p>由于cjson 采用链表储存了， 所以查找当时只能是暴力遍历了。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_GetArrayItem(cJSON *array,int item) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *c=array-&gt;child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (c &amp;&amp; item&gt;0) item--,c=c-&gt;next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return c;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_GetObjectItem(cJSON *object,const char *string) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *c=object-&gt;child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (c &amp;&amp; cJSON_strcasecmp(c-&gt;string,string)) c=c-&gt;next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return c;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<h4>修改节点</h4>
<p>我们查找到对应的节点了，就可以对节点进行简单的修改了。</p>
<p>什么是简单的修改呢？</p>
<p>节点的类型不是 array 和 object 都可以算是简单类型,可以直接修改修改其值即可。</p>
<p>但是对于 array 和 object, 我们想给他赋值的话，涉及到释放就得内存这个问题。</p>
<p>下面我们来看看 cjson 的实现代码。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Replace array/object items with new ones. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">void   cJSON_ReplaceItemInArray(cJSON *array,int which,cJSON *newitem) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *c=array-&gt;child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (c &amp;&amp; which&gt;0) c=c-&gt;next,which--;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!c) return;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    newitem-&gt;next=c-&gt;next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    newitem-&gt;prev=c-&gt;prev;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (newitem-&gt;next) newitem-&gt;next-&gt;prev=newitem;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (c==array-&gt;child) array-&gt;child=newitem;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else newitem-&gt;prev-&gt;next=newitem;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    c-&gt;next=c-&gt;prev=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON_Delete(c);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">void   cJSON_ReplaceItemInObject(cJSON *object,const char *string,cJSON *newitem) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    int i=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *c=object-&gt;child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while(c &amp;&amp; cJSON_strcasecmp(c-&gt;string,string))i++,c=c-&gt;next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if(c) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        newitem-&gt;string=cJSON_strdup(string);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON_ReplaceItemInArray(object,i,newitem);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<p>看到这，可能会产生一个疑问：为什么不先查找得到那个节点的父节点指向自己的指针的引用呢？</p>
<p>这又是一个很有趣的小知识点， 这里就不展开了。</p>
<p>实际上这是指针的知识点， 经常会在链表中遇到， 一不小心链表就会因为这个小问题而写残了。</p>
<p>我以前曾接介绍过这个问题，但不记得具体在哪里介绍了， 大概实在<a href="http://github.tiankonguse.com/blog/2014/11/04/hash-table/" target="_blank">hash table 研究与实现</a>或<a href="/shuoit/20141108/343083.html"" target="_blank">memcached 源码阅读之 hash table</a>吧。</p>
<p>好了， 这个修改操作其实就是链表的替换操作， 我就不展开讨论这个知识点了。</p>
<h3>json 解析</h3>
<h4>整体解析部分</h4>
<p>如果你看过我的<a href="/shuoit/20141129/343539.html"" target="_blank">sphinx 源码阅读之json, hash table配置分析器</a>的话， 你就会发现这个解析其实就是个自动机。</p>
<p>自动机可以使用一系列状态及模拟栈来实现， 也可以直接使用一些列的递归函数实现。</p>
<p>本质上是等价的， 建议自己都实现一下。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Utility to jump whitespace and cr/lf */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static const char *skip(const char *in) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (in &amp;&amp; *in &amp;&amp; (unsigned char)*in&lt;=32) in++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return in;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Parse an object - create a new root, and populate. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_ParseWithOpts(const char *value,const char **return_parse_end,int require_null_terminated) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    const char *end=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *c=cJSON_New_Item();</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    ep=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!c) return 0;       /* memory fail */</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    end=parse_value(c,skip(value));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!end) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON_Delete(c);    /* parse failure. ep is set. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    /* if we require null-terminated JSON without appended garbage, skip and then check for a null terminator */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (require_null_terminated) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        end=skip(end);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (*end) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            cJSON_Delete(c);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            ep=end;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (return_parse_end) *return_parse_end=end;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return c;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Default options for cJSON_Parse */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">cJSON *cJSON_Parse(const char *value) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return cJSON_ParseWithOpts(value,0,0);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<p>上面两个函数， 其实对我们有用的只有一句<code style="box-sizing: border-box; font-family: Courier; font-size: 14px; padding: 0px 5px; color: rgb(199, 37, 78); white-space: nowrap; background-color: rgb(238, 238, 238); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin: 0px; border: 1px solid rgb(204, 204, 204); line-height: 14px; word-wrap: break-word;">end=parse_value(c,skip(value));</code>, 也就是我们只需要了解一下<code style="box-sizing: border-box; font-family: Courier; font-size: 14px; padding: 0px 5px; color: rgb(199, 37, 78); white-space: nowrap; background-color: rgb(238, 238, 238); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin: 0px; border: 1px solid rgb(204, 204, 204); line-height: 14px; word-wrap: break-word;">parse_value</code>函数即可。</p>
<p>当然，skip 用于用于忽略空白，这里跳过了 ascii 值小于 32 的。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Parser core - when encountering text, process appropriately. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static const char *parse_value(cJSON *item,const char *value) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!value)return 0;/* Fail on null. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!strncmp(value,&quot;null&quot;,4)) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        item-&gt;type=cJSON_NULL;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return value+4;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!strncmp(value,&quot;false&quot;,5)) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        item-&gt;type=cJSON_False;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return value+5;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!strncmp(value,&quot;true&quot;,4)) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        item-&gt;type=cJSON_True;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        item-&gt;valueint=1;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return value+4;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value=='&quot;') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return parse_string(item,value);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value=='-' || (*value&gt;='0' &amp;&amp; *value&lt;='9')) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return parse_number(item,value);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value=='[') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return parse_array(item,value);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value=='{') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return parse_object(item,value);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    ep=value;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return 0;/* failure. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<p>parse_value 的实现方式很简单， 根据前几个字符来判断写一个类型是什么。</p>
<p>如果是 null, false 或 true 设置类型，并返回偏移指针。</p>
<p>如果是其他的，则进入对应的函数中。</p>
<h4>解析字符串部分</h4>
<p>解析字符串时， 对于特殊字符也应该转义，比如 &quot;n&quot; 字符应该转换为 'n' 这个换行符。</p>
<p>当然，如果只有特殊字符转换的话，代码不会又这么长， 对于字符串， 还要支持非 ascii 码的字符， 即 utf8字符。<br />
这些字符在字符串中会编码为 uXXXX 的字符串， 我们现在需要还原为 0-255 的一个字符。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static unsigned parse_hex4(const char *str) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    unsigned h=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*str&gt;='0' &amp;&amp; *str&lt;='9') h+=(*str)-'0';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else if (*str&gt;='A' &amp;&amp; *str&lt;='F') h+=10+(*str)-'A';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else if (*str&gt;='a' &amp;&amp; *str&lt;='f') h+=10+(*str)-'a';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    h=h&lt;&lt;4;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    str++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*str&gt;='0' &amp;&amp; *str&lt;='9') h+=(*str)-'0';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else if (*str&gt;='A' &amp;&amp; *str&lt;='F') h+=10+(*str)-'A';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else if (*str&gt;='a' &amp;&amp; *str&lt;='f') h+=10+(*str)-'a';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    h=h&lt;&lt;4;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    str++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*str&gt;='0' &amp;&amp; *str&lt;='9') h+=(*str)-'0';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else if (*str&gt;='A' &amp;&amp; *str&lt;='F') h+=10+(*str)-'A';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else if (*str&gt;='a' &amp;&amp; *str&lt;='f') h+=10+(*str)-'a';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    h=h&lt;&lt;4;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    str++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*str&gt;='0' &amp;&amp; *str&lt;='9') h+=(*str)-'0';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else if (*str&gt;='A' &amp;&amp; *str&lt;='F') h+=10+(*str)-'A';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else if (*str&gt;='a' &amp;&amp; *str&lt;='f') h+=10+(*str)-'a';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    else return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return h;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Parse the input text into an unescaped cstring, and populate item. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static const unsigned char firstByteMark[7] = { 0x00, 0x00, 0xC0, 0xE0, 0xF0, 0xF8, 0xFC };</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static const char *parse_string(cJSON *item,const char *str) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    const char *ptr=str+1;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    char *ptr2;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    char *out;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    int len=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    unsigned uc,uc2;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*str!='&quot;') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        ep=str;    /* not a string! */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (*ptr!='&quot;' &amp;&amp; *ptr &amp;&amp; ++len) if (*ptr++ == '') ptr++;/* Skip escaped quotes. */</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    out=(char*)cJSON_malloc(len+1);/* This is how long we need for the string, roughly. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!out) return 0;</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    ptr=str+1;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    ptr2=out;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (*ptr!='&quot;' &amp;&amp; *ptr) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (*ptr!='') *ptr2++=*ptr++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        else {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            ptr++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            switch (*ptr) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            case 'b':</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                *ptr2++='b';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            case 'f':</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                *ptr2++='f';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            case 'n':</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                *ptr2++='n';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            case 'r':</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                *ptr2++='r';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            case 't':</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                *ptr2++='t';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            case 'u': /* transcode utf16 to utf8. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                uc=parse_hex4(ptr+1);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                ptr+=4;/* get the unicode char. */</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                if ((uc&gt;=0xDC00 &amp;&amp; uc&lt;=0xDFFF) || uc==0)break;/* check for invalid.*/</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                if (uc&gt;=0xD800 &amp;&amp; uc&lt;=0xDBFF) {/* UTF16 surrogate pairs.*/</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    if (ptr[1]!='' || ptr[2]!='u')break;/* missing second-half of surrogate.*/</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    uc2=parse_hex4(ptr+3);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    ptr+=6;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    if (uc2&lt;0xDC00 || uc2&gt;0xDFFF)break;/* invalid second-half of surrogate.*/</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    uc=0x10000 + (((uc&amp;0x3FF)&lt;&lt;10) | (uc2&amp;0x3FF));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                len=4;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                if (uc&lt;0x80) len=1;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                else if (uc&lt;0x800) len=2;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                else if (uc&lt;0x10000) len=3;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                ptr2+=len;</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                switch (len) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                case 4:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    *--ptr2 =((uc | 0x80) &amp; 0xBF);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    uc &gt;&gt;= 6;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                case 3:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    *--ptr2 =((uc | 0x80) &amp; 0xBF);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    uc &gt;&gt;= 6;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                case 2:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    *--ptr2 =((uc | 0x80) &amp; 0xBF);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    uc &gt;&gt;= 6;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                case 1:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                    *--ptr2 =(uc | firstByteMark[len]);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                ptr2+=len;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            default:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                *ptr2++=*ptr;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">                break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            ptr++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    *ptr2=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*ptr=='&quot;') ptr++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;valuestring=out;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;type=cJSON_String;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return ptr;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<h4>解析数字</h4>
<p>数字解析需要考虑科学计数法， 即大概形式如下图</p>
<p><img src="http://img.kuqin.com/upimg/allimg/141224/214JV115-0.gif" alt="number-gif" /></p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Parse the input text to generate a number, and populate the result into item. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static const char *parse_number(cJSON *item,const char *num) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    double n=0,sign=1,scale=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    int subscale=0,signsubscale=1;</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*num=='-') sign=-1,num++;/* Has sign? */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*num=='0') num++;/* is zero */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*num&gt;='1' &amp;&amp; *num&lt;='9')don=(n*10.0)+(*num++ -'0');</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (*num&gt;='0' &amp;&amp; *num&lt;='9');/* Number? */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*num=='.' &amp;&amp; num[1]&gt;='0' &amp;&amp; num[1]&lt;='9') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        num++;   /* Fractional part? */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        don=(n*10.0)+(*num++ -'0'),scale--;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        while (*num&gt;='0' &amp;&amp; *num&lt;='9');</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*num=='e' || *num=='E') {/* Exponent? */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        num++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (*num=='+') num++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        else if (*num=='-') signsubscale=-1,num++;/* With sign? */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        while (*num&gt;='0' &amp;&amp; *num&lt;='9') subscale=(subscale*10)+(*num++ - '0');/* Number? */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    n=sign*n*pow(10.0,(scale+subscale*signsubscale));/* number = +/- number.fraction * 10^+/- exponent */</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;valuedouble=n;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;valueint=(int)n;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;type=cJSON_Number;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return num;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<h4>解析数组</h4>
<p>解析数组， 需要先遇到 '[' 这个符号， 然后挨个的读取节点内容， 节点使用 ',' 分隔， ',' 前后还可能有空格， 最后以 ']' 结尾。</p>
<p>我们要编写的也是这样。</p>
<p>先创建一个数组对象， 判断是否有儿子， 有的话读取第一个儿子， 然后判断是不是有 逗号， 有的话循环读取后面的儿子。</p>
<p>最后读取 ']' 即可。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Build an array from input text. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static const char *parse_array(cJSON *item,const char *value) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value!='[') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        ep=value;    /* not an array! */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;type=cJSON_Array;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    value=skip(value+1);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value==']') return value+1;/* empty array. */</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;child=child=cJSON_New_Item();</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!item-&gt;child) return 0; /* memory fail */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    value=skip(parse_value(child,skip(value)));/* skip any spacing, get the value. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!value) return 0;</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (*value==',') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON *new_item;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (!(new_item=cJSON_New_Item())) return 0; /* memory fail */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        child-&gt;next=new_item;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        new_item-&gt;prev=child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        child=new_item;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        value=skip(parse_value(child,skip(value+1)));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (!value) return 0;/* memory fail */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value==']') return value+1;/* end of array */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    ep=value;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return 0;/* malformed. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<h4>解析对象</h4>
<p>解析对象和解析数组类似， 只不过对象的一个儿子是个 key-value, key 是字符串， value 可能是任何值， key 和 value 用 &quot;:&quot; 分隔。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Build an object from the text. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static const char *parse_object(cJSON *item,const char *value) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value!='{') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        ep=value;    /* not an object! */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;type=cJSON_Object;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    value=skip(value+1);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value=='}') return value+1;/* empty array. */</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    item-&gt;child=child=cJSON_New_Item();</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!item-&gt;child) return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    value=skip(parse_string(child,skip(value)));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!value) return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    child-&gt;string=child-&gt;valuestring;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    child-&gt;valuestring=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value!=':') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        ep=value;    /* fail! */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    value=skip(parse_value(child,skip(value+1)));/* skip any spacing, get the value. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!value) return 0;</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (*value==',') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON *new_item;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (!(new_item=cJSON_New_Item()))return 0; /* memory fail */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        child-&gt;next=new_item;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        new_item-&gt;prev=child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        child=new_item;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        value=skip(parse_string(child,skip(value+1)));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (!value) return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        child-&gt;string=child-&gt;valuestring;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        child-&gt;valuestring=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (*value!=':') {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            ep=value;    /* fail! */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        value=skip(parse_value(child,skip(value+1)));/* skip any spacing, get the value. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (!value) return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (*value=='}') return value+1;/* end of array */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    ep=value;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return 0;/* malformed. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<p>这样都实现后， 字符串解析为 json 对象就实现了。</p>
<h3>json 序列化</h3>
<p>json 序列化也成为把 json 输出出来。</p>
<p>一般有两种输出：格式化输出，压缩输出。</p>
<p>简单的说就是要不要输出一些空白的问题。</p><div style="float: left;margin-top:0px;margin-right:0px">
<script type="text/javascript"><!--
google_ad_client = "ca-pub-9317413389774415";
/* 2012年底部广告336x280, */
google_ad_slot = "9618407928";
google_ad_width = 336;
google_ad_height = 280;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Render a cJSON item/entity/structure to text. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">char *cJSON_Print(cJSON *item) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return print_value(item,0,1);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">char *cJSON_PrintUnformatted(cJSON *item) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return print_value(item,0,0);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Render a value to text. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static char *print_value(cJSON *item,int depth,int fmt) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    char *out=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!item) return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    switch ((item-&gt;type)&amp;255) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    case cJSON_NULL:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        out=cJSON_strdup(&quot;null&quot;);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    case cJSON_False:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        out=cJSON_strdup(&quot;false&quot;);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    case cJSON_True:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        out=cJSON_strdup(&quot;true&quot;);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    case cJSON_Number:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        out=print_number(item);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    case cJSON_String:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        out=print_string(item);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    case cJSON_Array:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        out=print_array(item,depth,fmt);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    case cJSON_Object:</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        out=print_object(item,depth,fmt);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        break;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return out;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<p>由于基本类型输出的实现比较简单，这里就不多说了，这里只说说输出 对象的实现吧。</p>
<p>假设我们要使用格式化输出， 也就是美化输出。</p>
<p>cjson 的做法不是边分析 json 边输出， 而是预先将要输的内容全部按字符串存在内存中， 最后输出整个字符串。</p>
<p>这对于比较大的 json 来说， 内存就是个问题了。</p>
<p>另外，格式化输出依靠的是节点的深度， 这个也可以优化， 一般宽度超过80 时， 就需要从新的一行算起的。</p>
<pre class="prettyprint linenums" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; padding: 15px; margin-top: -20px; margin-bottom: 40px; line-height: 1.428571429; color: rgb(185, 189, 182); word-break: break-all; word-wrap: break-word; background-color: rgb(0, 0, 0); border: 0px solid rgb(136, 136, 136); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px;"><ol class="linenums" style="box-sizing: border-box; margin-bottom: 0px; margin-left: 25px; padding-top: 0px; padding-bottom: 0px;"><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">/* Render an object to text. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">static char *print_object(cJSON *item,int depth,int fmt) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    char **entries=0,**names=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    char *out=0,*ptr,*ret,*str;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    int len=7,i=0,j;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON *child=item-&gt;child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    int numentries=0,fail=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    /* Count the number of entries. */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (child) numentries++,child=child-&gt;next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    /* Explicitly handle empty object case */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!numentries) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        out=(char*)cJSON_malloc(fmt?depth+4:3);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (!out)return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        ptr=out;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        *ptr++='{';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (fmt) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            *ptr++='n';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            for (i=0; i&lt;depth-1; i++) *ptr++='t';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        *ptr++='}';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        *ptr++=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return out;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    /* Allocate space for the names and the objects */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    entries=(char**)cJSON_malloc(numentries*sizeof(char*));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!entries) return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    names=(char**)cJSON_malloc(numentries*sizeof(char*));</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!names) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON_free(entries);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    memset(entries,0,sizeof(char*)*numentries);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    memset(names,0,sizeof(char*)*numentries);</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    /* Collect all the results into our arrays: */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    child=item-&gt;child;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    depth++;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (fmt) len+=depth;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    while (child) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        names[i]=str=print_string_ptr(child-&gt;string);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        entries[i++]=ret=print_value(child,depth,fmt);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (str &amp;&amp; ret) len+=strlen(ret)+strlen(str)+2+(fmt?2+depth:0);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        else fail=1;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        child=child-&gt;next;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    /* Try to allocate the output string */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!fail) out=(char*)cJSON_malloc(len);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (!out) fail=1;</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    /* Handle failure */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (fail) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        for (i=0; i&lt;numentries; i++) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            if (names[i]) cJSON_free(names[i]);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">            if (entries[i]) cJSON_free(entries[i]);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        }</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON_free(names);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON_free(entries);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        return 0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    /* Compose the output: */</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    *out='{';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    ptr=out+1;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (fmt)*ptr++='n';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    *ptr=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    for (i=0; i&lt;numentries; i++) {</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (fmt) for (j=0; j&lt;depth; j++) *ptr++='t';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        strcpy(ptr,names[i]);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        ptr+=strlen(names[i]);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        *ptr++=':';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (fmt) *ptr++='t';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        strcpy(ptr,entries[i]);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        ptr+=strlen(entries[i]);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (i!=numentries-1) *ptr++=',';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        if (fmt) *ptr++='n';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        *ptr=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON_free(names[i]);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">        cJSON_free(entries[i]);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    }</code></li><li>&nbsp;</li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON_free(names);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    cJSON_free(entries);</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    if (fmt) for (i=0; i&lt;depth-1; i++) *ptr++='t';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    *ptr++='}';</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    *ptr++=0;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">    return out;</code></li><li><code style="box-sizing: border-box; font-family: Courier; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 0px; border: none; line-height: 14px; word-wrap: break-word; word-break: break-all;">}</code></li></ol></pre>
<p>《完》</p>
					</div>
					<div class="clear"></div>
					<!-- topics begin -->
					<div class="otherContent_01" style="margin-top:10px;">
						<div class="cMovie_01" style="position:relative">
							<div class="cM01_tit" >&gt; <strong>相关主题：</strong><span style="position:absolute;right:30px;top:1px"><a target="_blank" href="/topics/" >学习编程，上酷勤网&gt;&gt;</a></span></div>
						 
						 <div class="cM01_cont">
						  
							<div class="cM01_item">
							  <div class="cM01_pic">
							  <a href="/topics/YuEbao.html" target="_blank"><img src="http://www.kuqin.com/upimg/topic/Yu Ebao.jpg" width="90" height="90" alt="余额宝" /></a>
							  </div>
							   <div class="cM01_txt"><a href="/topics/YuEbao.html" target="_blank">余额宝</a></div>
							</div>
							 
							<div class="cM01_item">
							  <div class="cM01_pic">
							  <a href="/topics/ThurayaSatelliteSystem.html" target="_blank"><img src="http://www.kuqin.com/upimg/topic/ThurayaSatelliteSystem.jpg" width="90" height="90" alt="Thuraya卫星系统" /></a>
							  </div>
							   <div class="cM01_txt"><a href="/topics/ThurayaSatelliteSystem.html" target="_blank">Thuraya卫星系统</a></div>
							</div>
							 
							<div class="cM01_item">
							  <div class="cM01_pic">
							  <a href="/topics/standbytime.html" target="_blank"><img src="http://www.kuqin.com/upimg/topic/standbytime.jpg" width="90" height="90" alt="待机时间" /></a>
							  </div>
							   <div class="cM01_txt"><a href="/topics/standbytime.html" target="_blank">待机时间</a></div>
							</div>
							 
							<div class="cM01_item">
							  <div class="cM01_pic">
							  <a href="/topics/smartantenna.html" target="_blank"><img src="http://www.kuqin.com/upimg/topic/smartantenna.jpg" width="90" height="90" alt="智能天线" /></a>
							  </div>
							   <div class="cM01_txt"><a href="/topics/smartantenna.html" target="_blank">智能天线</a></div>
							</div>
							
							
						</div>
					   </div>
					</div>
					<!-- topics end -->
					
					<div class="clear"></div>
					<div class="entrycontent">
						<!-- Wumi Button BEGIN -->
						<p>
							<div class="wumii-hook">
								<input type="hidden" name="wurl" value="http://www.kuqin.com/shuoit/20141224/344068.html" />
								<input type="hidden" name="wtitle" value="cjson 源码阅读笔记" />
								<input type="hidden" name="wpic" value="http://img.kuqin.com/upimg/allimg/141224/2_1224214K0J46.gif" />
							</div>
							<script>
								var wumiiSitePrefix = "http://www.kuqin.com//";
							</script>
						</p>
						<!-- Wumi Button END -->
						<!-- JiaThis Button BEGIN -->
						<script language="JavaScript"  src="/new/js/jia3.js" type="text/JavaScript"></script>
						<script language="JavaScript"  src="/new/js/jia2.js" type="text/JavaScript"></script>
						<!-- JiaThis Button END -->
					</div>
				</div>
				<!-- PostContent end -->
				<!-- PageNavigation begin -->
				<div class="clear"></div>
				<div class="postnavi">
					<div class="previous_post">上一篇：<a href='/shuoit/20141222/344035.html'>漫谈Github与开源</a> </div>
					<div class="next_post">下一篇：<a href='/shuoit/20141224/344075.html'>为什么像RedHat那样的开源旗手很少？</a>  </div>
				</div>
				<!-- PageNavigation end -->
			</div>
			<!-- SinglePost end -->
			<!-- PostComment begin -->
			<div class="postcomment">
				<!-- PingLun.La Begin -->
				<!-- UY BEGIN -->
				<div id="uyan_frame"></div>
				<script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=89276" async=""></script>
				<!-- UY END -->
				<!-- PingLun.La End -->
				<div class="clear"></div>
			</div>
			<!-- PostComment end -->
		</div>
		</div>
		<!-- Content end -->
		<!-- Sidebar begin -->
		<div class="sidebar">
			<script language="JavaScript"  src="/new/js/right.js" type="text/JavaScript"></script>
			<ul>
				<li class="mostviews archivemostviews">
					<h3>&nbsp;<span class="mon">最火爆</span><span>最新鲜</span><span>最相关</span></h3>

					<ul>
					<li><a target="_blank" title="淘宝在数据处理领域的项目及开源产品介绍" href="/opensource/20110917/264847.html">淘宝在数据处理领域的项目及开源产品介绍</a></li>
<li><a target="_blank" title="如何使用Github上的开源项目" href="/opensource/20130523/334478.html">如何使用Github上的开源项目</a></li>
<li><a target="_blank" title="开源项目thrift 应用以及一些已知的问题" href="/opensource/20120507/320404.html">开源项目thrift 应用以及一些已知的问题</a></li>
<li><a target="_blank" title="直接拿来用！最火的前端开源项目" href="/opensource/20130628/334618.html">直接拿来用！最火的前端开源项目</a></li>
<li><a target="_blank" title="亚马逊开放Kindle操作系统源代码" href="/opensource/20090617/57262.html">亚马逊开放Kindle操作系统源代码</a></li>
<li><a target="_blank" title="JavaEye网站创始人范凯：晒晒我们的开源项目" href="/opensource/20121007/331906.html">JavaEye网站创始人范凯：晒晒我们的开源项目</a></li>
<li><a target="_blank" title="Amoeba -- 阿里巴巴工程师的开源项目之一" href="/opensource/20081023/24026.html">Amoeba -- 阿里巴巴工程师的开源项目之一</a></li>
<li><a target="_blank" title="从FFmpeg耻辱榜看开源软件的“潜规则”" href="/opensource/20100916/88066.html">从FFmpeg耻辱榜看开源软件的“潜规则”</a></li>
<li><a target="_blank" title="分布式块存储开源项目sheepdog内部实现机制" href="/opensource/20120207/317876.html">分布式块存储开源项目sheepdog内部实现机制</a></li>
<li><a target="_blank" title="2012年十大最成功开源项目" href="/opensource/20130120/333958.html">2012年十大最成功开源项目</a></li>

					</ul>
					<ul style="display:none;">
					<li><a target="_blank" title="为什么像RedHat那样的开源旗手很少？" href="/shuoit/20141224/344075.html">为什么像RedHat那样的开源旗手很少？</a></li>
<li><a target="_blank" title="cjson 源码阅读笔记" href="/shuoit/20141224/344068.html">cjson 源码阅读笔记</a></li>
<li><a target="_blank" title="漫谈Github与开源" href="/shuoit/20141222/344035.html">漫谈Github与开源</a></li>
<li><a target="_blank" title="物联网相关开源硬件" href="/shuoit/20141222/344032.html">物联网相关开源硬件</a></li>
<li><a target="_blank" title="机器学习的11个开源项目" href="/shuoit/20141221/344007.html">机器学习的11个开源项目</a></li>
<li><a target="_blank" title="Microsoft开源Orleans云计算web框架" href="/shuoit/20141218/343979.html">Microsoft开源Orleans云计算web框架</a></li>
<li><a target="_blank" title="Node.js一分为二：开源项目真需要“大管家”吗？" href="/shuoit/20141218/343971.html">Node.js一分为二：开源项目真需要“大管家”吗？</a></li>
<li><a target="_blank" title="5个造福世界的开源项目" href="/shuoit/20141213/343868.html">5个造福世界的开源项目</a></li>
<li><a target="_blank" title="快速开发移动医疗App！开源框架mHealhDroid" href="/shuoit/20141213/343867.html">快速开发移动医疗App！开源框架mHealhDroid</a></li>
<li><a target="_blank" title="直接Mark！开源的DevOps开发工具箱" href="/shuoit/20141209/343771.html">直接Mark！开源的DevOps开发工具箱</a></li>

					</ul>
					<ul style="display:none;">
					<li><a target="_blank" title="Nmap源码分析（脚本引擎）" href="/shuoit/20141124/343407.html">Nmap源码分析（脚本引擎）</a></li>
<li><a target="_blank" title="十个最值得阅读学习的C开源项目代码" href="/shuoit/20141028/342918.html">十个最值得阅读学习的C开源项目代码</a></li>
<li><a target="_blank" title="细数开源历史上的十个重大事件" href="/shuoit/20140825/341814.html">细数开源历史上的十个重大事件</a></li>
<li><a target="_blank" title="矩阵分解开源库libMF源码分析 " href="/shuoit/20140626/340827.html">矩阵分解开源库libMF源码分析 </a></li>
<li><a target="_blank" title="阿里DataX编译与案例" href="/shuoit/20140508/339760.html">阿里DataX编译与案例</a></li>
<li><a target="_blank" title="ASP.NET MVC源码现在可以下载了" href="/opensource/20080322/4931.html">ASP.NET MVC源码现在可以下载了</a></li>

					</ul>
					
				</li>		
				<li id="text-2" style="border:1px solid #F0C8C8;">
					<script type="text/javascript"><!--
					google_ad_client = "pub-9317413389774415";
					/* 2011文章右上角300&#42;250 */
					google_ad_slot = "7885739204";
					google_ad_width = 300;
					google_ad_height = 250;
					//-->
					</script>
					<script type="text/javascript"
					src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
					</script>
				</li>
				<li id="specialcatposts-3" class="widget wpyou_widget_SpecialCatPosts">
					<h3>&nbsp;&nbsp;<span>推荐阅读</span></h3>
					<ul>
					<li><a target="_blank" title="运作开源项目的一点经验" href="http://www.kuqin.com/opensource/20120404/319597.html" >运作开源项目的一点经验</a></li>
<li><a target="_blank" title="开源代码库Github受开发者欢迎 用户超140万" href="http://www.kuqin.com/opensource/20120317/318984.html" >开源代码库Github受开发者欢迎 用户超140万</a></li>

					</ul>
				</li>
				<li id="text-2" style="border:1px solid #F0C8C8;">
					<script type="text/javascript">/*120*270，创建于2011-2-9*/ var cpro_id = 'u371492';</script><script src="http://cpro.baidu.com/cpro/ui/f.js" type="text/javascript"></script>
					<script type="text/javascript">/*右侧顶部300*250，创建于2012-1-2*/ var cpro_id = 'u730982';</script><script src="http://cpro.baidu.com/cpro/ui/c.js" type="text/javascript"></script>
				</li>
			</ul>
		</div>
		<!-- Sidebar end -->
		<!--cos-html-cache-safe-tag-->
	</div>
	<!-- Container end -->
	<!-- FriendLink begin -->
	<!-- FriendLink end -->
	<!-- Footer begin -->
	<div class="footer">
		<div class="footpage">
			<ul>
			<script language="JavaScript"  src="/new/js/aboutus.js" type="text/JavaScript"></script></ul>
		</div>
		<div class="clear"></div>
	</div>
	<!-- Footer end -->
	<div class="clear"></div>
</div>
<!-- Wrapper end -->
<!-- Footer JavaScript begin -->
<div style="display:none"><script language="JavaScript" src="/js-and-css/tongji20120203.js" type="text/JavaScript"></script></div>
<script type="text/javascript">
	var wumiiParams = "&num=5&mode=2&pf=DedeCMS_V57_GBK_SP1";
</script>
<script type="text/javascript" id="wumiiRelatedItems" src="http://widget.wumii.com/ext/relatedItemsWidget.htm"></script>
<a href="http://www.wumii.com/widget/relatedItems.htm" rel="external nofollow" style="border:0;">
	<img src="http://static.wumii.com/images/pixel.png" alt="无觅相关文章插件，快速提升流量" style="border:0;padding:0;margin:0;" />
</a>
<!-- Footer JavaScript end -->
</body>
</html>
